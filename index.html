<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <meta name="theme-color" content="#07090f"/>
  <title>Control Metabisulfito â€” Sta. Rosa</title>
  <link rel="stylesheet" href="assets/styles.css"/>
  <style>
    /* â”€â”€ LOGIN â”€â”€ */
    #login-view {
      min-height: 100vh;
      display: flex; align-items: center; justify-content: center;
      padding: 20px;
      background: radial-gradient(ellipse 80% 60% at 50% -10%, #0d2540 0%, var(--bg) 70%);
    }
    .login-wrap { width: 100%; max-width: 400px; animation: slideUp .5s ease; }
    .login-brand {
      text-align: center; margin-bottom: 32px;
    }
    .login-brand-icon {
      width: 64px; height: 64px;
      background: var(--grad); border-radius: 18px;
      display: flex; align-items: center; justify-content: center;
      font-size: 28px; margin: 0 auto 14px;
      box-shadow: 0 0 40px #1a6cd433;
    }
    .login-brand-name {
      font-size: 18px; font-weight: 800; color: #d8e8ff; letter-spacing: .5px;
    }
    .login-brand-sub {
      font-size: 10px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-top: 4px;
    }
    .login-card {
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: 20px; padding: 32px 28px;
      box-shadow: var(--shadow);
    }
    .login-card .field { margin-bottom: 16px; }
    .lerror {
      background: #2d0a0a; border: 1px solid #991b1b; color: #fca5a5;
      border-radius: 10px; padding: 10px 14px; font-size: 13px;
      margin-bottom: 14px; display: none;
    }
    .btn-login {
      width: 100%; background: var(--grad); color: #fff;
      border: none; border-radius: 12px; padding: 14px;
      font-size: 14px; font-weight: 700; font-family: 'Syne', sans-serif;
      cursor: pointer; letter-spacing: .5px;
      transition: all .2s; margin-top: 4px;
    }
    .btn-login:hover:not(:disabled) { opacity: .88; transform: translateY(-1px); }
    .btn-login:disabled { opacity: .5; cursor: not-allowed; }

    /* â”€â”€ DASHBOARD â”€â”€ */
    #dashboard-view { display: none; }
    .dash-hero {
      padding: 24px 0 8px;
      animation: slideUp .4s ease;
    }
    .dash-greeting {
      font-size: 11px; font-weight: 600;
      color: var(--cyan); letter-spacing: 2px;
      text-transform: uppercase; margin-bottom: 6px;
    }
    .dash-title {
      font-size: 26px; font-weight: 800; color: #d8e8ff; line-height: 1.15;
    }
    .dash-title span { color: var(--cyan); }
    .dash-sub {
      font-size: 12px; color: var(--muted); margin-top: 6px;
    }

    /* MÃ³dulos grid */
    .modules-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 20px;
    }
    @media(min-width: 500px) {
      .modules-grid { grid-template-columns: repeat(3, 1fr); }
    }
    @media(min-width: 700px) {
      .modules-grid { grid-template-columns: repeat(3, 1fr); }
    }

    .module-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 20px 16px;
      cursor: pointer; text-decoration: none;
      display: flex; flex-direction: column;
      align-items: flex-start; gap: 10px;
      transition: all .22s cubic-bezier(.4,0,.2,1);
      position: relative; overflow: hidden;
      animation: slideUp .4s ease both;
    }
    .module-card::before {
      content: '';
      position: absolute; inset: 0;
      opacity: 0; transition: opacity .22s;
    }
    .module-card:hover {
      transform: translateY(-3px);
      border-color: var(--border2);
      box-shadow: 0 12px 40px rgba(0,0,0,.4);
    }
    .module-card:hover::before { opacity: 1; }
    .module-card:active { transform: translateY(0); }

    /* Color variants */
    .mc-blue   { --mc: #3a8eff; }
    .mc-cyan   { --mc: #00e5ff; }
    .mc-green  { --mc: #00e5a0; }
    .mc-orange { --mc: #ff8f3c; }
    .mc-purple { --mc: #9b7fff; }
    .mc-yellow { --mc: #ffd04d; }
    .mc-pink   { --mc: #ff6b9d; }
    .mc-red    { --mc: #ff4d4d; }

    .module-card::before {
      background: radial-gradient(circle at 80% 20%, color-mix(in srgb, var(--mc) 15%, transparent) 0%, transparent 70%);
    }
    .mc-icon {
      width: 42px; height: 42px; border-radius: 12px;
      background: color-mix(in srgb, var(--mc) 15%, transparent);
      border: 1px solid color-mix(in srgb, var(--mc) 30%, transparent);
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; flex-shrink: 0;
    }
    .mc-name {
      font-size: 13px; font-weight: 700;
      color: var(--text);
    }
    .mc-desc {
      font-size: 11px; color: var(--muted); line-height: 1.4;
    }
    .mc-arrow {
      margin-top: auto;
      font-size: 16px;
      color: color-mix(in srgb, var(--mc) 60%, transparent);
      align-self: flex-end;
      transition: transform .2s;
    }
    .module-card:hover .mc-arrow { transform: translateX(4px); }

    /* Admin only badge */
    .mc-admin-badge {
      position: absolute; top: 10px; right: 10px;
      font-size: 8px; font-weight: 700; letter-spacing: 1px;
      background: #ffd04d18; color: var(--yellow);
      border: 1px solid #ffd04d33; border-radius: 6px;
      padding: 2px 6px; text-transform: uppercase;
    }

    /* Quick stats bar */
    .quick-stats {
      display: flex; gap: 8px;
      margin-top: 16px; overflow-x: auto;
      padding-bottom: 4px;
      -webkit-overflow-scrolling: touch;
    }
    .qs-chip {
      flex-shrink: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px; padding: 8px 14px;
      display: flex; align-items: center; gap: 8px;
    }
    .qs-num {
      font-size: 16px; font-weight: 800;
      font-family: 'Space Mono', monospace;
    }
    .qs-lbl { font-size: 10px; color: var(--muted); }

    /* â”€â”€ Stagger delay â”€â”€ */
    .module-card:nth-child(1)  { animation-delay: .05s; }
    .module-card:nth-child(2)  { animation-delay: .10s; }
    .module-card:nth-child(3)  { animation-delay: .15s; }
    .module-card:nth-child(4)  { animation-delay: .20s; }
    .module-card:nth-child(5)  { animation-delay: .25s; }
    .module-card:nth-child(6)  { animation-delay: .30s; }
  </style>
</head>
<body>

<!-- LOADING -->
<div class="loader-screen" id="loading">
  <div class="loader-icon">ðŸ§ª</div>
  <div style="font-size:12px;color:var(--muted);font-weight:600;letter-spacing:1px">INICIANDO SISTEMA...</div>
  <div class="loader-bar"><div class="loader-fill"></div></div>
</div>

<!-- LOGIN -->
<div id="login-view" style="display:none">
  <div class="login-wrap">
    <div class="login-brand">
      <div class="login-brand-icon">ðŸ§ª</div>
      <div class="login-brand-name">Control Metabisulfito</div>
      <div class="login-brand-sub">Bodega Sta. Rosa Â· Marecuador</div>
    </div>
    <div class="login-card">
      <div id="lerror" class="lerror"></div>
      <div class="field">
        <label>Correo electrÃ³nico</label>
        <input id="l-email" type="email" placeholder="usuario@empresa.com"
          inputmode="email" autocomplete="email"
          onkeydown="if(event.key==='Enter')doLogin()"/>
      </div>
      <div class="field">
        <label>ContraseÃ±a</label>
        <input id="l-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
          autocomplete="current-password"
          onkeydown="if(event.key==='Enter')doLogin()"/>
      </div>
      <button class="btn-login" id="btn-login" onclick="doLogin()">
        INGRESAR AL SISTEMA
      </button>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard-view">
  <!-- Header -->
  <div class="header">
    <div class="header-logo">ðŸ§ª</div>
    <div>
      <div class="header-title">Control Metabisulfito</div>
      <div class="header-sub" id="h-user">Bodega Sta. Rosa</div>
    </div>
    <div class="header-right">
      <span id="h-role" class="badge-role badge-operario">operario</span>
      <button class="btn-exit" onclick="doLogout()">Salir</button>
    </div>
  </div>

  <div class="main" style="padding-top:10px">
    <!-- Hero -->
    <div class="dash-hero">
      <div class="dash-greeting">Bienvenido de vuelta</div>
      <div class="dash-title" id="dash-title">Dashboard <span>principal</span></div>
      <div class="dash-sub">Selecciona un mÃ³dulo para comenzar</div>
    </div>

    <!-- Quick stats -->
    <div class="quick-stats" id="quick-stats">
      <div class="qs-chip">
        <div>
          <div class="qs-num" style="color:var(--blue)" id="qs-total">â€”</div>
          <div class="qs-lbl">Despachos</div>
        </div>
      </div>
      <div class="qs-chip">
        <div>
          <div class="qs-num" style="color:var(--orange)" id="qs-kgd">â€”</div>
          <div class="qs-lbl">KG Despachados</div>
        </div>
      </div>
      <div class="qs-chip">
        <div>
          <div class="qs-num" style="color:var(--green)" id="qs-kgu">â€”</div>
          <div class="qs-lbl">KG Utilizados</div>
        </div>
      </div>
    </div>

    <!-- Modules grid -->
    <div class="modules-grid" id="modules-grid">
      <!-- Rendered by JS -->
    </div>
  </div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const FB_CFG = {
  apiKey:"AIzaSyA8Wvcv3MQNYJT-LNm3UBjG4ta1u-OwrGI",
  authDomain:"lector-qr-25878.firebaseapp.com",
  projectId:"lector-qr-25878",
  storageBucket:"lector-qr-25878.firebasestorage.app",
  messagingSenderId:"8007483133",
  appId:"1:8007483133:web:60b74409d146ad8a0bc894"
};

const app  = initializeApp(FB_CFG);
const db   = getFirestore(app);
const auth = getAuth(app);

const CDESP = "metabisulfito_despachos";
const CUSR  = "metabisulfito_usuarios";

// Timeout fallback
const fbTimeout = setTimeout(() => {
  document.getElementById("loading").style.display = "none";
  document.getElementById("login-view").style.display = "flex";
}, 7000);

onAuthStateChanged(auth, async user => {
  clearTimeout(fbTimeout);
  document.getElementById("loading").style.display = "none";

  if (!user) {
    document.getElementById("login-view").style.display = "flex";
    return;
  }

  try {
    const snap = await getDoc(doc(db, CUSR, user.uid));
    if (!snap.exists()) { await signOut(auth); showErr("Cuenta no registrada."); return; }
    const d = snap.data();
    if (d.activo === false) { await signOut(auth); showErr("Cuenta desactivada."); return; }

    const session = { uid: user.uid, email: user.email, nombre: d.nombre || user.email, role: d.rol };
    sessionStorage.setItem("mb_session", JSON.stringify(session));

    showDashboard(session, db, CDESP, auth);
  } catch(e) {
    showErr("Error: " + e.message);
    document.getElementById("login-view").style.display = "flex";
  }
});

window.doLogin = async function() {
  const email = document.getElementById("l-email").value.trim();
  const pass  = document.getElementById("l-pass").value;
  if (!email || !pass) { showErr("Ingresa correo y contraseÃ±a."); return; }
  const btn = document.getElementById("btn-login");
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Ingresando...';
  document.getElementById("lerror").style.display = "none";
  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch(e) {
    let m = "Correo o contraseÃ±a incorrectos.";
    if (e.code === "auth/too-many-requests") m = "Demasiados intentos. Espera unos minutos.";
    showErr(m);
    btn.disabled = false; btn.textContent = "INGRESAR AL SISTEMA";
  }
};

window.doLogout = async function() {
  await signOut(auth);
  sessionStorage.removeItem("mb_session");
  document.getElementById("dashboard-view").style.display = "none";
  document.getElementById("login-view").style.display = "flex";
};

function showErr(msg) {
  const e = document.getElementById("lerror");
  e.textContent = msg; e.style.display = "block";
}

async function showDashboard(session, db, CDESP, auth) {
  document.getElementById("login-view").style.display = "none";
  document.getElementById("dashboard-view").style.display = "block";

  document.getElementById("h-user").textContent = session.nombre;
  document.getElementById("dash-title").innerHTML =
    'Hola, <span>' + session.nombre.split(" ")[0] + '</span>';
  const roleEl = document.getElementById("h-role");
  roleEl.textContent = session.role;
  roleEl.className = "badge-role " + (session.role === "admin" ? "badge-admin" : "badge-operario");

  // Build module cards
  const ALL_MODULES = [
    {
      id: "ingresar", href: "modules/ingresar.html",
      icon: "ðŸ“‹", name: "Nuevo Despacho",
      desc: "Registrar salida de metabisulfito",
      color: "mc-blue", adminOnly: false,
    },
    {
      id: "dashboard", href: "modules/dashboard.html",
      icon: "ðŸ“Š", name: "Dashboard",
      desc: "EstadÃ­sticas y grÃ¡ficos de despachos",
      color: "mc-cyan", adminOnly: true,
    },
    {
      id: "registros", href: "modules/registros.html",
      icon: "ðŸ—ƒï¸", name: "Registros",
      desc: "Ver, editar y eliminar despachos",
      color: "mc-green", adminOnly: true,
    },
    {
      id: "reportes", href: "modules/reportes.html",
      icon: "ðŸ”", name: "Reportes",
      desc: "Filtrar y exportar datos",
      color: "mc-orange", adminOnly: true,
    },
    {
      id: "kardex", href: "modules/kardex.html",
      icon: "ðŸ“’", name: "Kardex",
      desc: "Movimientos con saldo corriente",
      color: "mc-purple", adminOnly: true,
    },
    {
      id: "usuarios", href: "modules/usuarios.html",
      icon: "ðŸ‘¥", name: "Usuarios",
      desc: "Crear y gestionar cuentas",
      color: "mc-yellow", adminOnly: true,
    },
  ];

  const grid = document.getElementById("modules-grid");
  const visible = ALL_MODULES.filter(m => !m.adminOnly || session.role === "admin");
  grid.innerHTML = visible.map(m => `
    <a class="module-card ${m.color}" href="${m.href}">
      ${m.adminOnly ? '<span class="mc-admin-badge">Admin</span>' : ''}
      <div class="mc-icon">${m.icon}</div>
      <div>
        <div class="mc-name">${m.name}</div>
        <div class="mc-desc">${m.desc}</div>
      </div>
      <div class="mc-arrow">â†’</div>
    </a>
  `).join("");

  // Load quick stats
  try {
    const snap = await getDocs(query(collection(db, CDESP), orderBy("createdAt","desc")));
    const regs = snap.docs.map(d => d.data());
    const total = regs.length;
    const kgd   = regs.reduce((s,r) => s + (parseFloat(r.cantKg)||0), 0);
    const kgv   = regs.reduce((s,r) => s + (parseFloat(r.devKg)||0), 0);
    document.getElementById("qs-total").textContent = total;
    document.getElementById("qs-kgd").textContent   = kgd.toFixed(0) + " kg";
    document.getElementById("qs-kgu").textContent   = (kgd-kgv).toFixed(0) + " kg";
  } catch(e) { console.warn("Stats:", e); }
}
</script>

</body>
</html>
